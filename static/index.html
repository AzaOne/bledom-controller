<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLEDOM Controller</title>
    
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material-darker.min.css">

<style>
    :root {
        --bg-light: #f5f5f5;
        --text-light: #333;
        --card-bg-light: white;
        --border-light: #ddd;
        --shadow-light: rgba(0,0,0,0.1);

        --bg-dark: #212121;
        --text-dark: #e0e0e0;
        --card-bg-dark: #333;
        --border-dark: #555;
        --shadow-dark: rgba(0,0,0,0.3);

        --primary-color: #2196F3;
        --accent-color: #4CAF50;
        --warn-color: #f44336;
        --notice-color: #ff9800; 
    }

    body {
        font-family: Roboto, sans-serif;
        margin: 0;
        background: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
    }
    
    #appContainer {
        max-width: 800px;
        margin: 20px auto;
        padding: 0 20px;
    }

    h1, h3, h4 { color: var(--text-light); transition: color 0.3s; }
    h4 { margin: 10px 0 5px; width: 100%; }

    button {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        margin: 4px;
        transition: opacity 0.2s;
        -webkit-tap-highlight-color: transparent;
    }
    button:hover { opacity: 0.9; }

    hr { border: none; border-top: 1px solid var(--border-light); margin: 20px 0; transition: border-top-color 0.3s; }
    
    code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; }

    label { display: block; margin: 8px 0; }
    input[type="text"], select { 
        width: 100%; 
        box-sizing: border-box; 
        padding: 8px; 
        margin: 5px 0 10px 0; 
        border: 1px solid var(--border-light); 
        border-radius: 4px; 
        background-color: white;
        color: var(--text-light);
    }

    .control-section {
        margin-bottom: 20px;
        background: var(--card-bg-light);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px var(--shadow-light);
        transition: background-color 0.3s, box-shadow 0.3s;
    }

    .control-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-light);
        font-size: 1.2em;
        font-weight: 500;
        transition: border-bottom-color 0.3s;
    }
    
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    .status {
        padding: 5px 10px;
        background: #e0e0e0;
        border-radius: 4px;
        display: inline-block;
        margin-bottom: 10px;
        transition: background-color 0.3s, color 0.3s;
    }

    .status.disconnected, 
    .status.connecting, 
    .status.agent-connected, 
    .status.device-disconnected, 
    .status.connected {
        color: white;
    }

    .status.connecting { background: #9e9e9e; }
    .status.disconnected { background: var(--warn-color); }
    .status.agent-connected { background: var(--primary-color); }
    .status.device-disconnected { background: var(--notice-color); }
    .status.connected { background: var(--accent-color); }

    .dark-mode .status.connecting { background-color: #555; }
    
    .control-grid { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }

    body.dark-mode { background: var(--bg-dark); color: var(--text-dark); }
    .dark-mode h1, .dark-mode h3, .dark-mode h4 { color: var(--text-dark); }
    .dark-mode .control-section { background: var(--card-bg-dark); box-shadow: 0 2px 4px var(--shadow-dark); border: 1px solid #444; }
    .dark-mode .control-section h3 { border-bottom-color: var(--border-dark); }
    .dark-mode hr { border-top-color: var(--border-dark); }
    .dark-mode select, .dark-mode input[type="text"] { background-color: #424242; color: var(--text-dark); border-color: var(--border-dark); }
    .dark-mode .CodeMirror { border-color: var(--border-dark); }
    .dark-mode code { background-color: #555; }
    .dark-mode #scheduleList li { border-bottom-color: var(--border-dark); }
    .dark-mode .docs-section, .dark-mode details.control-section { background-color: #2c2c2c; border-color: var(--border-dark); }

    .pattern-status { font-style: italic; color: #666; }
    #scheduleList { list-style: none; padding: 0; }
    #scheduleList li { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
    #scheduleList li:last-child { border-bottom: none; }
    .editor-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 10px; }
    
    .CodeMirror {
        border: 1px solid #ddd;
        height: 300px;
        font-size: 14px;
        border-radius: 4px;
    }

    .docs-section summary { padding: 10px 0; }
    .docs-content { padding-top: 10px; }
    .docs-content p { line-height: 1.6; }
    .docs-content ul { padding-left: 20px; }
    .docs-content li { margin-bottom: 10px; }

    a {
        color: #ADD8E6;
        text-decoration: none;
    }
    a:hover {
        color: #87CEEB;
        text-decoration: underline;
    }
    
    .color-presets button { width: 40px; height: 40px; margin: 0; padding: 0; border: 2px solid transparent; cursor: pointer; border-radius: 4px; transition: all 0.2s; font-weight: bold; }
    .color-presets button:hover { border-color: #333; transform: scale(1.1); }
    .color-presets input[type=color] { width: 50px; height: 40px; vertical-align: middle; border: none; border-radius: 4px; cursor: pointer; padding: 0; }

    input[type="range"] { width: 100%; margin-top: 5px; }

    .brightness-presets {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .brightness-presets button {
        background-color: #f0f0f0;
        color: #555;
        font-size: 1em;
        padding: 8px 16px;
        margin: 0;
        border: 1px solid #ccc;
        border-radius: 20px;
        transition: all 0.2s ease-in-out;
        user-select: none;
    }

    .brightness-presets button:hover {
        opacity: 1;
        border-color: #888;
    }
    
    .brightness-presets button.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .dark-mode .brightness-presets button {
        border-color: var(--border-dark);
        background-color: var(--card-bg-dark);
        color: var(--text-dark);
    }

    .dark-mode .brightness-presets button:hover {
        border-color: #777;
    }
    
    .dark-mode .brightness-presets button.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    #patternGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-top: 10px; }
    .pattern-button { background-color: var(--card-bg-light); color: var(--text-light); border: 2px solid var(--border-light); border-radius: 8px; padding: 8px; display: flex; flex-direction: column; align-items: center; height: 90px; }
    .pattern-preview { width: 100%; height: 40px; border-radius: 4px; margin-bottom: 8px; border: 1px solid var(--border-light); }
    .pattern-name { font-size: 12px; text-align: center; }
    
    .weekday-selector { display: flex; gap: 5px; margin: 10px 0; flex-wrap: wrap; justify-content: center; }
    .weekday-selector label { position: relative; display: inline-block; }
    .weekday-selector input { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }
    .weekday-selector span { display: block; padding: 8px 12px; border: 1px solid #ccc; border-radius: 20px; background-color: #f0f0f0; color: #555; transition: all 0.2s ease-in-out; text-align: center; user-select: none; }
    .weekday-selector input:checked + span { background-color: var(--primary-color); color: white; border-color: #1976D2; }
    .weekday-selector label:hover span { border-color: #888; }
    .time-picker-container { display: flex; align-items: center; gap: 8px; margin: 5px 0 15px 0; flex-wrap: wrap; }

    .time-picker-container { display: flex; align-items: center; gap: 8px; margin: 5px 0 15px 0; flex-wrap: wrap; }
    .time-picker-container select { width: auto; flex-grow: 1; }
    .time-picker-container span { font-weight: bold; font-size: 1.2em; color: #888; }

    .dark-mode .pattern-button { background-color: var(--card-bg-dark); color: var(--text-dark); border-color: var(--border-dark); }
    .dark-mode .pattern-preview { border-color: var(--border-dark); }
    .dark-mode .weekday-selector span { border-color: var(--border-dark); background-color: var(--card-bg-dark); color: var(--text-dark); }
    .dark-mode .weekday-selector input:checked + span { background-color: var(--primary-color); }
    .dark-mode .weekday-selector label:hover span { border-color: #777; }

    @keyframes fade7 { 0%, 100% { background-color: red; } 14% { background-color: orange; } 28% { background-color: yellow; } 42% { background-color: green; } 57% { background-color: blue; } 71% { background-color: indigo; } 85% { background-color: violet; } }
    @keyframes jump3 { 0%, 100% { background-color: red; } 33% { background-color: green; } 66% { background-color: blue; } }
    @keyframes strobe { 0%, 100% { opacity: 1; } 50% { opacity: 0.1; } }
    @keyframes rainbow-chase { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
    @keyframes red-green-fade { 0%, 100% { background-color: red; } 50% { background-color: green; } }
    @keyframes red-blue-fade { 0%, 100% { background-color: red; } 50% { background-color: blue; } }
    @keyframes green-blue-fade { 0%, 100% { background-color: green; } 50% { background-color: blue; } }

    .pattern-anim-static { background-color: #FF5555; }
    .pattern-anim-fade-3 { animation: jump3 5s infinite ease-in-out; }
    .pattern-anim-fade-7 { animation: fade7 10s infinite ease-in-out; }
    .pattern-anim-jump-3 { animation: jump3 2s infinite steps(1, end); }
    .pattern-anim-jump-7 { animation: fade7 3s infinite steps(1, end); }
    .pattern-anim-strobe-r { background-color: red; animation: strobe 0.5s infinite ease-in-out; }
    .pattern-anim-strobe-g { background-color: green; animation: strobe 0.5s infinite ease-in-out; }
    .pattern-anim-strobe-b { background-color: blue; animation: strobe 0.5s infinite ease-in-out; }
    .pattern-anim-strobe-w { background-color: white; animation: strobe 0.5s infinite ease-in-out; }
    .pattern-anim-strobe-7 { animation: fade7 1s infinite steps(1, end), strobe 1s infinite ease-in-out; }
    .pattern-anim-chase { background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet, red); background-size: 800% 100%; animation: rainbow-chase 6s linear infinite; }
</style>
</head>
<body>
    <div id="appContainer">
        <header>
            <h1>BLEDOM Controller</h1>
            <button id="darkModeToggle" title="Toggle Dark Mode"><span class="material-icons">dark_mode</span></button>
        </header>

        <div id="connectionStatus" class="status">Connecting...</div>

        <main id="controls" style="display: none;">

            <div class="control-section">
                <h3>Power Control</h3>
                <div class="control-grid">
                    <button id="powerOnBtn" style="background:var(--accent-color);">ON</button>
                    <button id="powerOffBtn" style="background:var(--warn-color);">OFF</button>
                </div>
            </div>

            <div class="control-section">
                <h3>Color & Brightness</h3>
                <div class="color-presets control-grid">
                    <h4>Colors</h4>
                    <button data-color="#FF0000" style="background:#FF0000;" title="Red">R</button>
                    <button data-color="#00FF00" style="background:#00FF00;" title="Green">G</button>
                    <button data-color="#0000FF" style="background:#0000FF;" title="Blue">B</button>
                    <input type="color" id="customColorInput" value="#FF0000" title="Custom Color">
                </div>
                <hr>
                <div class="color-presets control-grid">
                    <h4>Presets</h4>
                    <button data-color="#FF4500" style="background:#FF4500;" title="OrangeRed"></button>
                    <button data-color="#FFD700" style="background:#FFD700;" title="Gold"></button>
                    <button data-color="#ADFF2F" style="background:#ADFF2F;" title="GreenYellow"></button>
                    <button data-color="#00CED1" style="background:#00CED1;" title="DarkTurquoise"></button>
                    <button data-color="#9400D3" style="background:#9400D3;" title="DarkViolet"></button>
                    <button data-color="#FF1493" style="background:#FF1493;" title="DeepPink"></button>
                    <button data-color="#FFFFFF" style="background:#FFFFFF; border: 1px solid #ccc;" title="White"></button>
                </div>
                <hr>
                <label>Brightness: <span id="brightnessValue">100%</span></label>
                <input type="range" id="brightnessSlider" min="1" max="100" value="100">
                <div class="brightness-presets control-grid">
                    <button data-brightness="2">2%</button>
                    <button data-brightness="5">5%</button>
                    <button data-brightness="10">10%</button>
                    <button data-brightness="15">15%</button>
                    <button data-brightness="20">20%</button>
                    <button data-brightness="25">25%</button>
                    <button data-brightness="50">50%</button>
                    <button data-brightness="75">75%</button>
                    <button data-brightness="100">100%</button>
                </div>
            </div>

            <div class="control-section">
                <h3>Hardware Effect Modes</h3>
                <div id="patternGrid"></div>
                <hr>
                <label>Effect Speed: <span id="speedValue">50%</span></label>
                <input type="range" id="speedSlider" min="0" max="100" value="50">
            </div>

            <div class="control-section">
                <h3>Lua Patterns</h3>
                <div class="editor-controls">
                    <label style="flex-grow: 1;">Pattern: <select id="patternSelector"></select></label>
                </div>
                <div class="editor-controls">
                    <button id="runPatternBtn">Run Pattern</button>
                    <button id="stopPatternBtn" style="background-color: var(--warn-color);">Stop Pattern</button>
                </div>
                <p>Status: <span id="patternStatus" class="pattern-status">Idle</span></p>
            </div>

            <div class="control-section">
                <h3>Pattern Editor</h3>
                <div class="editor-controls">
                    <label style="flex-grow: 1;">Load Pattern to Edit: <select id="editorPatternSelector"></select></label>
                </div>
                <div class="editor-controls">
                    <button id="loadPatternBtn">Load</button>
                    <button id="newPatternBtn">New</button>
                </div>
                <label>Filename (must end with .lua):</label>
                <input type="text" id="editorFilename" placeholder="new-pattern.lua">
                <div id="codeEditor"></div>
                <div class="editor-controls" style="margin-top: 10px;">
                    <button id="savePatternBtn" style="background-color: var(--accent-color);">Save Pattern</button>
                    <button id="deletePatternBtn" style="background-color: var(--warn-color);">Delete Pattern</button>
                </div>
            </div>

            <div class="control-section">
                <h3>Scheduler (Agent)</h3>
                <label>Schedule (Cron Spec):</label>
                <input type="text" id="scheduleSpec" placeholder="* * * * *">
                <label>Command:</label>
                <input type="text" id="scheduleCommand" placeholder="power off / pattern sunrise.lua / lua set_color(255,0,0)">
                <button id="addScheduleBtn">Add Schedule</button>
                <h4>Current Schedules</h4>
                <ul id="scheduleList">
                    <li>No schedules defined.</li>
                </ul>
            </div>

            
            <div class="control-section docs-section">
                <summary><h3>Documentation</h3></summary>
                    <h4>Lua Pattern API</h4>
                    Create custom animations by writing Lua scripts. The agent provides several global functions you can call from your script.
                    <ul>
                        <li><code>set_power(boolean)</code><br>Turns the LEDs on or off. Example: <code>set_power(true)</code></li>
                        <li><code>set_color(r, g, b)</code><br>Sets the static color. Values are 0-255. Example: <code>set_color(255, 0, 100)</code></li>
                        <li><code>set_brightness(value)</code><br>Sets the brightness. Value is 1-100. Example: <code>set_brightness(75)</code></li>
                        <li><code>sleep(milliseconds)</code><br>Pauses the script for a given duration. Example: <code>sleep(50)</code></li>
                        <li><code>should_stop()</code><br><strong>(For pattern files only)</strong> Returns <code>true</code> if the user has clicked "Stop Pattern". Check this in long loops to make your pattern responsive. Example: <code>if should_stop() then return end</code></li>
                        <li><code>print(message)</code><br>Prints a message to the Go agent's console log, useful for debugging. Example: <code>print("Loop: " .. i)</code></li>
                    </ul>
                    <h4>High-Level Effects</h4>
                    These functions perform complex animations and will block your script until they are complete or cancelled.
                    <ul>
                         <li><code>breathe(duration_ms)</code><br>Performs a smooth "breathing" pulse from 1% to 100% brightness and back. The color should be set beforehand. Example: <code>set_color(0, 255, 255); breathe(4000) -- 4 second cyan pulse</code></li>
                         <li><code>strobe(r, g, b, duration_ms, frequency_hz)</code><br>Flashes the specified color for a total duration. Example: <code>strobe(255, 255, 255, 5000, 10) -- 5 seconds of white strobe at 10 Hz</code></li>
                         <li><code>fade(r1, g1, b1, r2, g2, b2, duration_ms)</code><br>Smoothly transitions from a start color to an end color. Example: <code>fade(255, 0, 0, 0, 0, 255, 3000) -- 3 second fade from red to blue</code></li>
                    </ul>
                    <hr>
                    <h4>Scheduler</h4>
                    The scheduler uses standard Cron syntax to automate commands. You can trigger power events, run full pattern files, or execute light Lua scripts.
                    <ul>
                        <li><strong>Cron Syntax:</strong> <code>MINUTE HOUR DAY-OF-MONTH MONTH DAY-OF-WEEK</code>.<br><em>Example:</em> <code>0 22 * * 1-5</code> means "at 22:00 (10 PM) on Monday through Friday".<br><a href="https://crontab.guru/" target="_blank" rel="noopener">Use crontab.guru to easily build expressions.</a></li>
                        <li><strong>Available Commands:</strong>
                            <ul>
                                <li><code>power on</code> / <code>power off</code> - Turns the LEDs on or off.</li>
                                <li><code>pattern [filename.lua]</code> - Runs a full Lua pattern file. Example: <code>pattern sunrise.lua</code></li>
                                <li><code>lua [lua_code]</code> - Executes a single line of Lua code.<br><em>Example 1: Set color to purple.</em> <code>lua set_color(128, 0, 255)</code><br><em>Example 2: A 5-second blue flash.</em> <code>lua set_power(true); set_color(0, 0, 255); sleep(5000); set_power(false)</code></li>
                            </ul>
                        </li>
                    </ul>
            </div>
            <div class="control-section">
                <summary><h3>Advanced Device Settings</h3></summary>
                <h4>On-Device Scheduling</h4>
                <button id="syncTimeBtn">Sync Time</button>
                <button id="clearScheduleBtn" style="background:var(--warn-color)">Clear Device Schedule</button>
                <hr>
                <div class="time-picker-container">
                    <select id="scheduleHour"></select><span>:</span>
                    <select id="scheduleMinute"></select><span>:</span>
                    <select id="scheduleSecond"></select>
                </div>
                <div class="weekday-selector">
                    <label><input type="checkbox" name="weekday" value="6"><span>Su</span></label>
                    <label><input type="checkbox" name="weekday" value="0"><span>Mo</span></label>
                    <label><input type="checkbox" name="weekday" value="1"><span>Tu</span></label>
                    <label><input type="checkbox" name="weekday" value="2"><span>We</span></label>
                    <label><input type="checkbox" name="weekday" value="3"><span>Th</span></label>
                    <label><input type="checkbox" name="weekday" value="4"><span>Fr</span></label>
                    <label><input type="checkbox" name="weekday" value="5"><span>Sa</span></label>
                </div>
                <label>Action:
                    <select id="scheduleAction">
                        <option value="on">Turn ON</option>
                        <option value="off">Turn OFF</option>
                    </select>
                </label>
                <button id="setScheduleBtn">Set Device Schedule</button>
                <hr>
                <h4>RGB Wire Order</h4>
                <div class="control-grid">
                    <label>1st Wire: <select id="wire1"><option value="1" selected>Red</option><option value="2">Green</option><option value="3">Blue</option></select></label>
                    <label>2nd Wire: <select id="wire2"><option value="1">Red</option><option value="2" selected>Green</option><option value="3">Blue</option></select></label>
                    <label>3rd Wire: <select id="wire3"><option value="1">Red</option><option value="2">Green</option><option value="3" selected>Blue</option></select></label>
                </div>
                <button id="setRgbOrderBtn">Set Order</button>
            </div>


        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/lua/lua.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let socket;
    let editor;
    const debounceTimeouts = {};

    const HARDWARE_PATTERNS = [
        { id: 0, name: 'Static Red', animClass: 'pattern-anim-static', style: 'background-color:#ff0000;' },
        { id: 1, name: 'Static Blue', animClass: 'pattern-anim-static', style: 'background-color:#0000ff;' },
        { id: 2, name: 'Static Green', animClass: 'pattern-anim-static', style: 'background-color:#00ff00;' },
        { id: 3, name: 'Static Cyan', animClass: 'pattern-anim-static', style: 'background-color:#00ffff;' },
        { id: 4, name: 'Static Yellow', animClass: 'pattern-anim-static', style: 'background-color:#ffff00;' },
        { id: 5, name: 'Static Purple', animClass: 'pattern-anim-static', style: 'background-color:#ff00ff;' },
        { id: 6, name: 'Static White', animClass: 'pattern-anim-static', style: 'background-color: gainsboro;' },
        { id: 7, name: '3 Color Jumping', animClass: 'pattern-anim-jump-3' },
        { id: 8, name: '7 Color Jumping', animClass: 'pattern-anim-jump-7' },
        { id: 9, name: '3 Color Cross Fade', animClass: 'pattern-anim-fade-3' },
        { id: 10, name: '7 Color Cross Fade', animClass: 'pattern-anim-fade-7' },
        { id: 11, name: 'Red Gradual', animClass: 'pattern-anim-strobe-r'},
        { id: 12, name: 'Green Gradual', animClass: 'pattern-anim-strobe-g'},
        { id: 13, name: 'Blue Gradual', animClass: 'pattern-anim-strobe-b'},
        { id: 14, name: 'Yellow Gradual', animClass: 'pattern-anim-strobe-w', style: 'background-color: yellow;'},
        { id: 15, name: 'Cyan Gradual', animClass: 'pattern-anim-strobe-w', style: 'background-color: cyan;'},
        { id: 16, name: 'Purple Gradual', animClass: 'pattern-anim-strobe-w', style: 'background-color: purple;'},
        { id: 17, name: 'White Gradual', animClass: 'pattern-anim-strobe-w', style: 'background-color: gainsboro;'},
        { id: 18, name: 'Red/Green Fade', animClass: 'pattern-anim-fade-3', style: 'animation-name: red-green-fade;'}, 
        { id: 19, name: 'Red/Blue Fade', animClass: 'pattern-anim-fade-3', style: 'animation-name: red-blue-fade;'},
        { id: 20, name: 'Green/Blue Fade', animClass: 'pattern-anim-fade-3', style: 'animation-name: green-blue-fade;'},
        { id: 21, name: '7 color Strobe', animClass: 'pattern-anim-strobe-7' },
        { id: 22, name: 'Red Strobe', animClass: 'pattern-anim-strobe-r' },
        { id: 23, name: 'Green Strobe', animClass: 'pattern-anim-strobe-g' },
        { id: 24, name: 'Blue Strobe', animClass: 'pattern-anim-strobe-b' },
        { id: 25, name: 'Yellow Strobe', animClass: 'pattern-anim-strobe-w', style: 'background-color: yellow;' },
        { id: 26, name: 'Cyan Strobe', animClass: 'pattern-anim-strobe-w', style: 'background-color: cyan;' },
        { id: 27, name: 'Purple Strobe', animClass: 'pattern-anim-strobe-w', style: 'background-color: purple;' },
        { id: 28, name: 'White Strobe', animClass: 'pattern-anim-strobe-w', style: 'background-color: gainsboro;'}
    ];

    const ui = {
        statusDiv: document.getElementById('connectionStatus'),
        controls: document.getElementById('controls'),
        darkModeToggle: document.getElementById('darkModeToggle'),

        powerOnBtn: document.getElementById('powerOnBtn'),
        powerOffBtn: document.getElementById('powerOffBtn'),
        customColorInput: document.getElementById('customColorInput'),
        brightnessSlider: document.getElementById('brightnessSlider'),
        brightnessValue: document.getElementById('brightnessValue'),

        patternGrid: document.getElementById('patternGrid'),
        speedSlider: document.getElementById('speedSlider'),
        speedValue: document.getElementById('speedValue'),

        syncTimeBtn: document.getElementById('syncTimeBtn'),
        setScheduleBtn: document.getElementById('setScheduleBtn'),
        clearScheduleBtn: document.getElementById('clearScheduleBtn'),
        scheduleHour: document.getElementById('scheduleHour'),
        scheduleMinute: document.getElementById('scheduleMinute'),
        scheduleSecond: document.getElementById('scheduleSecond'),
        scheduleAction: document.getElementById('scheduleAction'),
        setRgbOrderBtn: document.getElementById('setRgbOrderBtn'),
        wire1: document.getElementById('wire1'), wire2: document.getElementById('wire2'), wire3: document.getElementById('wire3'),

        patternSelector: document.getElementById('patternSelector'),
        editorPatternSelector: document.getElementById('editorPatternSelector'),
        runPatternBtn: document.getElementById('runPatternBtn'),
        stopPatternBtn: document.getElementById('stopPatternBtn'),
        patternStatus: document.getElementById('patternStatus'),
        loadPatternBtn: document.getElementById('loadPatternBtn'),
        newPatternBtn: document.getElementById('newPatternBtn'),
        savePatternBtn: document.getElementById('savePatternBtn'),
        deletePatternBtn: document.getElementById('deletePatternBtn'),
        editorFilename: document.getElementById('editorFilename'),

        scheduleList: document.getElementById('scheduleList'),
        addScheduleBtn: document.getElementById('addScheduleBtn'),
        scheduleSpec: document.getElementById('scheduleSpec'),
        scheduleCommand: document.getElementById('scheduleCommand'),
    };

    function initCodeMirror() {
        editor = CodeMirror(document.getElementById('codeEditor'), {
            mode: 'lua', theme: 'material-darker', lineNumbers: true,
            value: '-- Click "New" or "Load" to start editing a pattern.\n'
        });
    }

    function sendSocketCommand(type, payload) {
        if (!socket || socket.readyState !== WebSocket.OPEN) { return; }
        socket.send(JSON.stringify({ type, payload }));
    }

    function debounce(func, args, key, delay = 50) {
        clearTimeout(debounceTimeouts[key]);
        debounceTimeouts[key] = setTimeout(() => func(...args), delay);
    }

    const deviceAPI = {
        setPower: (isOn) => sendSocketCommand('setPower', { isOn }),
        setColor: (r, g, b) => sendSocketCommand('setColor', { r, g, b }),
        setBrightness: (value) => debounce(sendSocketCommand, ['setBrightness', { value: parseInt(value) }], 'brightness', 100),
        setHardwarePattern: (id) => sendSocketCommand('setHardwarePattern', { id }),
        setSpeed: (value) => debounce(sendSocketCommand, ['setSpeed', { value: parseInt(value) }], 'speed', 50),
        syncTime: () => sendSocketCommand('syncTime', {}),
        setRgbOrder: (v1, v2, v3) => sendSocketCommand('setRgbOrder', { v1, v2, v3 }),
        setDeviceSchedule: (isSet) => {
            const hour = parseInt(ui.scheduleHour.value);
            const minute = parseInt(ui.scheduleMinute.value);
            const second = parseInt(ui.scheduleSecond.value);
            const isOn = ui.scheduleAction.value === 'on';
            let weekdays = 0;
            document.querySelectorAll('input[name="weekday"]:checked').forEach(day => {
                weekdays |= (1 << parseInt(day.value));
            });
            sendSocketCommand('setSchedule', { hour, minute, second, weekdays, isOn, isSet });
        },
        runPattern: (name) => sendSocketCommand('runPattern', { name }),
        stopPattern: () => sendSocketCommand('stopPattern', {}),
        addSchedule: (spec, command) => sendSocketCommand('addSchedule', { spec, command }),
        removeSchedule: (id) => sendSocketCommand('removeSchedule', { id }),
        getPatternCode: (name) => sendSocketCommand('getPatternCode', { name }),
        savePatternCode: (name, code) => sendSocketCommand('savePatternCode', { name, code }),
        deletePattern: (name) => sendSocketCommand('deletePattern', { name }),
    };

    function renderHardwarePatterns() {
        ui.patternGrid.innerHTML = '';
        HARDWARE_PATTERNS.forEach(p => {
            const button = document.createElement('button');
            button.className = 'pattern-button';
            button.title = p.name;
            button.innerHTML = `<div class="pattern-preview ${p.animClass || ''}" style="${p.style || ''}"></div><span class="pattern-name">${p.name}</span>`;
            button.onclick = () => deviceAPI.setHardwarePattern(p.id);
            ui.patternGrid.appendChild(button);
        });
    }

    function populateTimePickers() {
        const pad = (num) => String(num).padStart(2, '0');
        for (let i = 0; i < 60; i++) {
            if (i < 24) ui.scheduleHour.add(new Option(pad(i), i));
            ui.scheduleMinute.add(new Option(pad(i), i));
            ui.scheduleSecond.add(new Option(pad(i), i));
        }
    }

    function updatePatternLists(patterns) {
        const createOptions = (selectElem) => {
            const currentVal = selectElem.value;
            selectElem.innerHTML = '';
             if (patterns && patterns.length > 0) {
                patterns.forEach(name => selectElem.add(new Option(name, name)));
                if(patterns.includes(currentVal)) selectElem.value = currentVal;
            } else {
                selectElem.innerHTML = '<option disabled>No patterns found</option>';
            }
        };
        createOptions(ui.patternSelector);
        createOptions(ui.editorPatternSelector);
    }
    
    function updateScheduleList(schedules) {
        ui.scheduleList.innerHTML = '';
        if (schedules && Object.keys(schedules).length > 0) {
            for (const id in schedules) {
                const item = schedules[id];
                const li = document.createElement('li');
                li.innerHTML = `<span><code>${item.spec}</code> &rarr; <code>${item.command}</code></span>
                              <button class="remove-schedule-btn" data-id="${id}" style="background-color:var(--warn-color); padding: 5px 10px; font-size: 0.8em;">Remove</button>`;
                ui.scheduleList.appendChild(li);
            }
        } else {
            ui.scheduleList.innerHTML = '<li>No schedules defined.</li>';
        }
    }

    function connect() {
        const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${proto}//${window.location.host}/ws`;
        socket = new WebSocket(wsUrl);

        const setStatus = (cssClass, message) => {
            const statusClasses = ['connecting', 'disconnected', 'agent-connected', 'device-disconnected', 'connected'];
            ui.statusDiv.classList.remove(...statusClasses);
            ui.statusDiv.classList.add(cssClass);
            ui.statusDiv.textContent = message;
        };

        socket.onopen = () => {
            console.log("WebSocket connection established");
            setStatus('agent-connected', 'Agent Connected, awaiting device status...');
        };

        socket.onclose = () => {
            console.log('WebSocket connection closed. Retrying...');
            setStatus('disconnected', 'Agent Disconnected. Retrying...');
            ui.controls.style.display = 'none';
            setTimeout(connect, 3000);
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            switch (msg.type) {
                case 'ble_status':
                    ui.controls.style.display = 'block';
                    if (msg.payload.connected) {
                        const rssi = msg.payload.rssi;
                        let statusText = 'Device Connected';
                        if (rssi && rssi !== 0) {
                             statusText += ` (RSSI: ${rssi} dBm)`;
                        }
                        setStatus('connected', statusText);
                    } else {
                        setStatus('device-disconnected', 'Device Disconnected (Agent is running)');
                    }
                    break;
                case 'pattern_list': updatePatternLists(msg.payload); break;
                case 'schedule_list': updateScheduleList(msg.payload); break;
                case 'pattern_status': ui.patternStatus.textContent = msg.payload.running || 'Idle'; break;
                case 'pattern_code':
                    ui.editorFilename.value = msg.payload.name;
                    editor.setValue(msg.payload.code);
                    break;
            }
        };
    }

    function initEventListeners() {
        ui.powerOnBtn.addEventListener('click', () => deviceAPI.setPower(true));
        ui.powerOffBtn.addEventListener('click', () => deviceAPI.setPower(false));

        const handleColorChange = (hex) => {
            const bigint = parseInt(hex.substring(1), 16);
            deviceAPI.setColor((bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255);
        };
        ui.customColorInput.addEventListener('input', (e) => debounce(handleColorChange, [e.target.value], 'color', 100));
        
        document.querySelectorAll('.color-presets button[data-color]').forEach(button => {
            button.addEventListener('click', () => {
                handleColorChange(button.dataset.color);
                ui.customColorInput.value = button.dataset.color;
            });
        });

        ui.brightnessSlider.addEventListener('input', (e) => {
            ui.brightnessValue.textContent = `${e.target.value}%`;
            deviceAPI.setBrightness(e.target.value)
        });

        document.querySelectorAll('.brightness-presets button').forEach(button => {
            button.addEventListener('click', () => {
                const val = button.dataset.brightness;
                ui.brightnessSlider.value = val;
                ui.brightnessValue.textContent = `${val}%`;
                deviceAPI.setBrightness(val);
            });
        });

        ui.speedSlider.addEventListener('input', (e) => {
            ui.speedValue.textContent = `${e.target.value}%`;
            const maxDuration = 15; const minDuration = 0.2;
            const duration = maxDuration - ((parseInt(e.target.value) / 100) * (maxDuration - minDuration));
            deviceAPI.setSpeed(e.target.value);
            document.querySelectorAll('.pattern-preview').forEach(preview => {
                if (window.getComputedStyle(preview).animationName !== 'none') {
                    preview.style.animationDuration = `${duration}s`;
                }
            });
        });

        ui.syncTimeBtn.addEventListener('click', deviceAPI.syncTime);
        ui.setRgbOrderBtn.addEventListener('click', () => {
            deviceAPI.setRgbOrder(parseInt(ui.wire1.value), parseInt(ui.wire2.value), parseInt(ui.wire3.value));
        });
        ui.setScheduleBtn.addEventListener('click', () => deviceAPI.setDeviceSchedule(true));
        ui.clearScheduleBtn.addEventListener('click', () => deviceAPI.setDeviceSchedule(false));
        
        ui.runPatternBtn.addEventListener('click', () => { if (ui.patternSelector.value) deviceAPI.runPattern(ui.patternSelector.value); });
        ui.stopPatternBtn.addEventListener('click', deviceAPI.stopPattern);

        ui.loadPatternBtn.addEventListener('click', () => { if (ui.editorPatternSelector.value) deviceAPI.getPatternCode(ui.editorPatternSelector.value); });
        ui.newPatternBtn.addEventListener('click', () => {
            ui.editorFilename.value = 'new-pattern.lua';
            editor.setValue('-- Your new Lua pattern code here\n\n');
            ui.editorFilename.focus();
        });
        ui.savePatternBtn.addEventListener('click', () => {
            const filename = ui.editorFilename.value.trim();
            if (!filename || !filename.endsWith('.lua')) { alert('Filename is invalid. It must not be empty and must end with .lua'); return; }
            deviceAPI.savePatternCode(filename, editor.getValue());
            alert(`Pattern "${filename}" saved!`);
        });
        ui.deletePatternBtn.addEventListener('click', () => {
            const filename = ui.editorPatternSelector.value;
            if (filename && confirm(`Are you sure you want to permanently delete "${filename}"?`)) {
                deviceAPI.deletePattern(filename);
                if (ui.editorFilename.value === filename) ui.newPatternBtn.click();
            }
        });

        ui.addScheduleBtn.addEventListener('click', () => {
            const spec = ui.scheduleSpec.value.trim();
            const command = ui.scheduleCommand.value.trim();
            if (spec && command) deviceAPI.addSchedule(spec, command);
            else alert('Please provide both a cron spec and a command.');
        });
        ui.scheduleList.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-schedule-btn')) {
                const id = e.target.dataset.id;
                if (confirm(`Are you sure you want to remove this schedule?`)) deviceAPI.removeSchedule(id);
            }
        });

        const initDarkMode = () => {
            if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            }
            const isDark = document.body.classList.contains('dark-mode');
            document.querySelector('#darkModeToggle .material-icons').textContent = isDark ? 'light_mode' : 'dark_mode';
        };
        
        ui.darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('#darkModeToggle .material-icons').textContent = isDark ? 'light_mode' : 'dark_mode';
        });
        initDarkMode();
    }

    initCodeMirror();
    initEventListeners();
    renderHardwarePatterns();
    populateTimePickers();
    connect();
});
</script>
</body>
</html>
